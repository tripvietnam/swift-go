<?php 
/* Template Name: My Account (Static) */
include __DIR__ . '/header.html';
?>
<section class="account-page">
  <div class="container">
    <div class="section-head">
      <h2>Tài khoản của tôi</h2>
      <p>Quản lý thông tin cá nhân & mật khẩu</p>
    </div>

    <div id="account-not-logged" class="account-box" style="display:none;">
      <p>Bạn chưa đăng nhập. Vui lòng đăng nhập hoặc đăng ký để quản lý tài khoản.</p>
      <div class="account-actions">
        <button class="btn btn-primary" id="account-login-btn">Đăng nhập</button>
        <button class="btn btn-ghost" id="account-register-btn">Đăng ký</button>
      </div>
    </div>

    <div id="account-content" class="account-box" style="display:none;">
      <form id="account-form" class="account-form">
        <h3>Thông tin cơ bản</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Họ và tên</label>
            <input type="text" name="fullname" required minlength="2" />
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" name="email" readonly />
          </div>
          <div class="form-group">
            <label>Số điện thoại</label>
            <input type="tel" name="phone" placeholder="0912345678" />
          </div>
        </div>
        <h3>Đổi mật khẩu <small class="muted" style="font-weight:400;">(bỏ qua nếu không đổi)</small></h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Mật khẩu hiện tại</label>
            <input type="password" name="current_password" placeholder="Nhập mật khẩu cũ" autocomplete="current-password" />
          </div>
          <div class="form-group">
            <label>Mật khẩu mới</label>
            <input type="password" name="new_password" placeholder="Tối thiểu 6 ký tự" minlength="6" autocomplete="new-password" />
          </div>
          <div class="form-group">
            <label>Xác nhận mật khẩu mới</label>
            <input type="password" name="confirm_new_password" placeholder="Nhập lại mật khẩu" minlength="6" autocomplete="new-password" />
          </div>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
          <button type="button" id="logout-account" class="btn btn-ghost">Đăng xuất</button>
        </div>
        <div id="account-message" class="form-message" style="display:none;"></div>
      </form>
    </div>
  </div>
</section>

<style>
.account-box{background:#fff;border:1px solid var(--line);border-radius:8px;padding:24px;box-shadow:var(--shadow);margin-bottom:32px;}
.account-form h3{margin:24px 0 12px;font-size:18px;color:var(--text);}
.account-form .form-grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));}
.account-form .form-group label{display:block;font-weight:600;margin-bottom:6px;font-size:14px;color:var(--text);}
.account-form .form-group input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:6px;font-size:14px;font-family:inherit;transition:border-color .2s,box-shadow .2s;}
.account-form .form-group input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(0,59,149,.15);}
.form-actions{display:flex;gap:12px;margin-top:12px;}
.form-message{margin-top:16px;padding:12px 16px;border-radius:6px;font-size:14px;font-weight:500;}
.form-message.success{background:#e6f5e9;color:#1b6e2b;border:1px solid #b7e2c1;}
.form-message.error{background:#fdecea;color:#b1282d;border:1px solid #f5c2c4;}
.muted{color:var(--muted);}
@media (max-width:640px){.account-form .form-grid{grid-template-columns:1fr;} .form-actions{flex-direction:column;} .form-actions .btn{width:100%;}}
</style>

<script>
(function(){
  const accountContent = document.getElementById('account-content');
  const notLoggedBox = document.getElementById('account-not-logged');
  const form = document.getElementById('account-form');
  const messageEl = document.getElementById('account-message');
  const loginBtn = document.getElementById('account-login-btn');
  const registerBtn = document.getElementById('account-register-btn');
  const logoutBtn = document.getElementById('logout-account');

  function showMessage(type, text){
    messageEl.className = 'form-message ' + (type === 'success' ? 'success' : 'error');
    messageEl.textContent = text;
    messageEl.style.display = 'block';
    setTimeout(()=>{messageEl.style.display='none';}, 4000);
  }

  function loadUser(){
    const user = window.SwiftGoAuth?.getCurrentUser();
    if(!user){
      notLoggedBox.style.display='block';
      accountContent.style.display='none';
      return;
    }
    notLoggedBox.style.display='none';
    accountContent.style.display='block';
    form.fullname.value = user.fullname || '';
    form.email.value = user.email || '';
    form.phone.value = user.phone || '';
  }

  loginBtn?.addEventListener('click', ()=> window.SwiftGoAuth?.openLogin());
  registerBtn?.addEventListener('click', ()=> window.SwiftGoAuth?.openRegister());
  logoutBtn?.addEventListener('click', ()=> window.SwiftGoAuth?.logout());

  form?.addEventListener('submit', function(e){
    e.preventDefault();
    const user = window.SwiftGoAuth?.getCurrentUser();
    if(!user){showMessage('error','Bạn chưa đăng nhập.');return;}

    const fullname = form.fullname.value.trim();
    const phone = form.phone.value.trim();
    const currentPass = form.current_password.value;
    const newPass = form.new_password.value;
    const confirmNew = form.confirm_new_password.value;

    // Load user list
    const usersStr = localStorage.getItem('swiftgo_users') || '[]';
    const users = JSON.parse(usersStr);
    const idx = users.findIndex(u => u.email === user.email);
    if(idx === -1){showMessage('error','Không tìm thấy tài khoản trong hệ thống.');return;}

    // Update basic info
    users[idx].fullname = fullname;
    users[idx].phone = phone;

    // Handle password change if fields filled
    if(currentPass || newPass || confirmNew){
      if(!currentPass || !newPass || !confirmNew){
        showMessage('error','Vui lòng điền đủ 3 ô mật khẩu để đổi.');
        return;
      }
      if(users[idx].password !== currentPass){
        showMessage('error','Mật khẩu hiện tại không đúng.');
        return;
      }
      if(newPass.length < 6){
        showMessage('error','Mật khẩu mới tối thiểu 6 ký tự.');
        return;
      }
      if(newPass !== confirmNew){
        showMessage('error','Xác nhận mật khẩu mới không khớp.');
        return;
      }
      users[idx].password = newPass;
    }

    // Persist
    localStorage.setItem('swiftgo_users', JSON.stringify(users));
    // Update current user (no password)
    const { password, ...savedUser } = users[idx];
    localStorage.setItem('swiftgo_user', JSON.stringify(savedUser));
    window.SwiftGoAuth?.updateCartCount?.();
    showMessage('success','Cập nhật tài khoản thành công.');
    // Clear password fields
    form.current_password.value='';
    form.new_password.value='';
    form.confirm_new_password.value='';
  });

  document.addEventListener('DOMContentLoaded', loadUser);
  loadUser();
})();
</script>
<?php include __DIR__ . '/footer.html'; ?>

